<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blynk IoT Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the dashboard */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* gray-800 */
        }
        .card {
            background-color: #374151; /* gray-700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            color: #d1d5db; /* gray-300 */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563; /* gray-600 */
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2563eb; /* blue-600 */
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .status-dot {
            height: 20px;
            width: 20px;
            background-color: #6b7280; /* gray-500 */
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .status-dot.active {
            background-color: #ef4444; /* red-500 */
        }
        .gauge-container {
            position: relative;
            width: 150px;
            height: 150px;
        }
        .gauge-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .gauge-bg {
            fill: none;
            stroke: #4b5563; /* gray-600 */
            stroke-width: 12;
        }
        .gauge-fill {
            fill: none;
            stroke: #3b82f6; /* blue-500 */
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease-in-out;
        }
        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.875rem; /* text-3xl */
            font-weight: bold;
            color: #f9fafb; /* gray-50 */
        }
        .gauge-label {
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #9ca3af; /* gray-400 */
        }
        .gauge-min-max {
            position: absolute;
            bottom: -5px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem; /* text-xs */
            color: #9ca3af; /* gray-400 */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-6">IoT Dashboard</h1>

        <!-- Switches -->
        <div id="switch-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Switch cards will be generated by JavaScript -->
        </div>

        <!-- Status Indicators -->
        <div id="status-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Status indicator cards will be generated by JavaScript -->
        </div>

        <!-- Gauges -->
        <div id="gauge-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Gauge cards will be generated by JavaScript -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- BLYNK CONFIGURATION ---
        // IMPORTANT: Replace with your Blynk Auth Token.
        const BLYNK_AUTH_TOKEN = "YOUR_BLYNK_AUTH_TOKEN"; 
        // Use blynk.cloud for the new Blynk platform. Or your custom server address.
        const BLYNK_SERVER_HOST = "blynk.cloud"; 

        // --- UI ELEMENT CONFIGURATION ---
        // Map your UI elements to Blynk Virtual Pins here.
        
        const switches = [
            { label: 'Motor Switch', pin: 'V1', offText: 'OFF', onText: 'ON' },
            { label: 'Light Switch', pin: 'V2', offText: 'OFF', onText: 'ON' },
            { label: 'Fire Kill Switch', pin: 'V3', offText: 'OFF', onText: 'ON' },
            { label: 'Alarm Switch', pin: 'V4', offText: 'OFF', onText: 'ON' },
        ];

        const statuses = [
            { label: 'Motor ON', pin: 'V5' },
            { label: 'Motor OFF', pin: 'V6' },
            { label: 'Voltage Alert', pin: 'V7' },
            { label: 'Light', pin: 'V8' },
            { label: 'Gas', pin: 'V9' },
            { label: 'Speaker Status', pin: 'V10' },
            { label: 'Rain LED', pin: 'V11' },
            { label: 'Motion', pin: 'V12' },
        ];

        const gauges = [
            { label: 'Shallow Moisture', pin: 'V13', min: 1, max: 4095, unit: '' },
            { label: 'Deeper Moisture', pin: 'V14', min: 1, max: 4095, unit: '' },
            { label: 'Mid Moisture', pin: 'V15', min: 1, max: 4095, unit: '' },
            { label: 'Gas Level', pin: 'V16', min: 0, max: 100, unit: '%' },
            { label: 'Voltage', pin: 'V17', min: 0, max: 44, unit: 'V' },
            { label: 'Water level', pin: 'V18', min: 0, max: 100, unit: '%' },
            { label: 'Temperature', pin: 'V19', min: 0, max: 150, unit: 'Â°C' },
            { label: 'Humidity', pin: 'V20', min: 0, max: 100, unit: '%' },
        ];

        const switchContainer = document.getElementById('switch-container');
        const statusContainer = document.getElementById('status-container');
        const gaugeContainer = document.getElementById('gauge-container');

        // --- DYNAMIC UI GENERATION ---

        // Generate Switches
        switches.forEach(s => {
            const card = document.createElement('div');
            card.className = 'card flex-row justify-between';
            card.innerHTML = `
                <div class="flex items-center">
                    <span class="font-bold text-lg">${s.label}</span>
                </div>
                <div class="flex items-center space-x-3">
                    <label class="toggle-switch">
                        <input type="checkbox" id="switch-${s.pin}" data-pin="${s.pin}">
                        <span class="slider"></span>
                    </label>
                    <span id="switch-text-${s.pin}" class="font-bold text-lg w-12 text-right">${s.offText}</span>
                </div>
            `;
            switchContainer.appendChild(card);
        });

        // Generate Status Indicators
        statuses.forEach(s => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <span class="font-semibold">${s.label}</span>
                <div id="status-${s.pin}" class="status-dot mt-2"></div>
            `;
            statusContainer.appendChild(card);
        });

        // Generate Gauges
        gauges.forEach(g => {
            const card = document.createElement('div');
            card.className = 'card';
            const radius = 60;
            const circumference = 2 * Math.PI * radius;
            card.innerHTML = `
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 150 150">
                        <circle class="gauge-bg" cx="75" cy="75" r="${radius}"></circle>
                        <circle id="gauge-fill-${g.pin}" class="gauge-fill" cx="75" cy="75" r="${radius}"
                                stroke-dasharray="${circumference}" stroke-dashoffset="${circumference}"></circle>
                    </svg>
                    <div id="gauge-text-${g.pin}" class="gauge-text">--</div>
                    <div class="gauge-min-max">
                        <span>${g.min}</span>
                        <span>${g.max}</span>
                    </div>
                </div>
                <div class="gauge-label">${g.label}</div>
            `;
            gaugeContainer.appendChild(card);
        });
        
        // --- BLYNK API INTERACTION ---

        const blynkApi = {
            // Function to get a single pin value
            get: async (pin) => {
                if (BLYNK_AUTH_TOKEN === "YOUR_BLYNK_AUTH_TOKEN") return null;
                try {
                    const url = `https://${BLYNK_SERVER_HOST}/external/api/get?token=${BLYNK_AUTH_TOKEN}&${pin}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.error(`Blynk API Error for pin ${pin}: ${response.statusText}`);
                        return null;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Failed to fetch from Blynk for pin ${pin}:`, error);
                    return null;
                }
            },
            // Function to update a pin value
            update: async (pin, value) => {
                 if (BLYNK_AUTH_TOKEN === "YOUR_BLYNK_AUTH_TOKEN") {
                    console.warn("Blynk Auth Token not set. Cannot update pin.");
                    return;
                }
                try {
                    const url = `https://${BLYNK_SERVER_HOST}/external/api/update?token=${BLYNK_AUTH_TOKEN}&${pin}=${value}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.error(`Blynk API Error on update for pin ${pin}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error(`Failed to update Blynk pin ${pin}:`, error);
                }
            }
        };

        // --- UI UPDATE FUNCTIONS ---

        function updateSwitch(pin, value) {
            const switchConfig = switches.find(s => s.pin === pin);
            if (!switchConfig) return;

            const checkbox = document.getElementById(`switch-${pin}`);
            const text = document.getElementById(`switch-text-${pin}`);
            
            if (checkbox && text) {
                const isChecked = value == 1;
                checkbox.checked = isChecked;
                text.textContent = isChecked ? switchConfig.onText : switchConfig.offText;
            }
        }

        function updateStatus(pin, value) {
            const statusDot = document.getElementById(`status-${pin}`);
            if (statusDot) {
                if (value == 1) {
                    statusDot.classList.add('active');
                } else {
                    statusDot.classList.remove('active');
                }
            }
        }

        function updateGauge(pin, value) {
            const gaugeConfig = gauges.find(g => g.pin === pin);
            if (!gaugeConfig) return;

            const gaugeFill = document.getElementById(`gauge-fill-${pin}`);
            const gaugeText = document.getElementById(`gauge-text-${pin}`);

            if (!gaugeFill || !gaugeText) return;

            // Update text value
            const displayValue = parseFloat(value).toFixed(gaugeConfig.max > 1000 ? 0 : 1);
            gaugeText.textContent = isNaN(displayValue) ? '--' : displayValue.replace('.0', '');


            // Update gauge arc
            const radius = 60;
            const circumference = 2 * Math.PI * radius;
            const normalizedValue = Math.max(0, Math.min(1, (value - gaugeConfig.min) / (gaugeConfig.max - gaugeConfig.min)));
            const offset = circumference * (1 - normalizedValue);
            
            gaugeFill.style.strokeDashoffset = isNaN(offset) ? circumference : offset;
        }

        // --- MAIN DATA FETCH LOOP ---

        async function refreshDashboard() {
            if (BLYNK_AUTH_TOKEN === "YOUR_BLYNK_AUTH_TOKEN") {
                console.warn("Please set your BLYNK_AUTH_TOKEN in the script.");
                // You can populate with dummy data here for testing
                // updateGauge('V17', 25);
                return;
            }

            const pinsToFetch = [
                ...switches.map(s => s.pin),
                ...statuses.map(s => s.pin),
                ...gauges.map(g => g.pin)
            ];
            
            const pinParams = pinsToFetch.join('&');
            const data = await blynkApi.get(pinParams);

            if (data) {
                switches.forEach(s => updateSwitch(s.pin, data[s.pin]));
                statuses.forEach(s => updateStatus(s.pin, data[s.pin]));
                gauges.forEach(g => updateGauge(g.pin, data[g.pin]));
            }
        }

        // --- EVENT LISTENERS ---
        
        switchContainer.addEventListener('change', (event) => {
            if (event.target.type === 'checkbox') {
                const pin = event.target.dataset.pin;
                const value = event.target.checked ? 1 : 0;
                
                // Update text immediately for better UX
                const switchConfig = switches.find(s => s.pin === pin);
                const text = document.getElementById(`switch-text-${pin}`);
                if(switchConfig && text) {
                    text.textContent = value === 1 ? switchConfig.onText : switchConfig.offText;
                }

                blynkApi.update(pin, value);
            }
        });

        // --- INITIALIZATION ---
        
        // Initial fetch and then set an interval to refresh
        refreshDashboard();
        setInterval(refreshDashboard, 5000); // Refresh every 5 seconds
    });
    </script>
</body>
</html>
